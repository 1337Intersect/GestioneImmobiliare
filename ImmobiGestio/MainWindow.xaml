<Window x:Class="ImmobiGestio.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:viewmodels="clr-namespace:ImmobiGestio.ViewModels"
        xmlns:views="clr-namespace:ImmobiGestio.Views"
        Title="{Binding WindowTitle}" Height="900" Width="1400"
        WindowStartupLocation="CenterScreen"
        WindowState="Maximized"
        Closing="Window_Closing">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisConverter"/>

        <!-- Data Templates per i diversi ViewModels -->
        <DataTemplate DataType="{x:Type viewmodels:DashboardViewModel}">
            <TextBlock Text="Dashboard - In Development" FontSize="24" HorizontalAlignment="Center" VerticalAlignment="Center"/>
        </DataTemplate>

        <!-- Data Template Immobili Inline -->
        <DataTemplate DataType="{x:Type viewmodels:ImmobiliViewModel}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Toolbar -->
                <StackPanel Grid.Row="0" Orientation="Horizontal" Background="#FFF5F5F5" Margin="5">
                    <Button Content="➕ Nuovo Immobile" Command="{Binding AddImmobileCommand}" 
                            Background="#FF4CAF50" Foreground="White" Margin="5" Padding="10,5"/>
                    <Button Content="💾 Salva" Command="{Binding SaveImmobileCommand}" 
                            Background="#FFFF9800" Foreground="White" Margin="5" Padding="10,5"/>
                    <Button Content="🗑️ Elimina" Command="{Binding DeleteImmobileCommand}" 
                            Background="#FFF44336" Foreground="White" Margin="5" Padding="10,5"/>
                    <Separator Margin="10,0"/>

                    <Label Content="🔍" VerticalAlignment="Center"/>
                    <TextBox Width="200" Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" 
                             VerticalAlignment="Center" Margin="5" Padding="5"
                             ToolTip="Cerca immobili"/>
                </StackPanel>

                <!-- Content -->
                <Grid Grid.Row="1">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="350"/>
                        <ColumnDefinition Width="5"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Lista Immobili -->
                    <GroupBox Grid.Column="0" Header="📋 Lista Immobili" Margin="5">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <ListBox Grid.Row="0" ItemsSource="{Binding Immobili}" 
                                     SelectedItem="{Binding SelectedImmobile}">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Border BorderBrush="#FFEEEEEE" BorderThickness="0,0,0,1" Padding="5">
                                            <StackPanel>
                                                <TextBlock Text="{Binding Titolo}" FontWeight="Bold" FontSize="14"/>
                                                <TextBlock Text="{Binding Indirizzo}" FontSize="11" Foreground="Gray"/>
                                                <StackPanel Orientation="Horizontal" Margin="0,2">
                                                    <TextBlock Text="{Binding Prezzo, StringFormat=€ {0:N0}}" 
                                                               FontWeight="Bold" Foreground="Green"/>
                                                    <TextBlock Text=" • " Foreground="Gray"/>
                                                    <TextBlock Text="{Binding TipoImmobile}" FontSize="10" Foreground="Blue"/>
                                                </StackPanel>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>

                            <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="5">
                                <TextBlock Text="{Binding TotaleImmobili, StringFormat=Totale: {0}}" 
                                           FontSize="10" Foreground="Gray"/>
                            </StackPanel>
                        </Grid>
                    </GroupBox>

                    <GridSplitter Grid.Column="1" HorizontalAlignment="Stretch" Background="LightGray"/>

                    <!-- Dettagli Immobile -->
                    <ScrollViewer Grid.Column="2" VerticalScrollBarVisibility="Auto">
                        <StackPanel>
                            <!-- Placeholder quando nessun immobile è selezionato -->
                            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Margin="50">
                                <StackPanel.Style>
                                    <Style TargetType="StackPanel">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding SelectedImmobile}" Value="{x:Null}">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </StackPanel.Style>
                                <TextBlock Text="🏠" FontSize="48" HorizontalAlignment="Center" Foreground="#FFCCCCCC"/>
                                <TextBlock Text="Seleziona un immobile dalla lista" FontSize="16" HorizontalAlignment="Center" 
                                           Foreground="#FF666666" Margin="0,10"/>
                            </StackPanel>

                            <!-- Form quando immobile è selezionato -->
                            <StackPanel DataContext="{Binding SelectedImmobile}" Margin="10">
                                <StackPanel.Style>
                                    <Style TargetType="StackPanel">
                                        <Setter Property="Visibility" Value="Visible"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding}" Value="{x:Null}">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </StackPanel.Style>

                                <GroupBox Header="🏠 Informazioni Generali" Margin="5">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <Label Grid.Row="0" Grid.Column="0" Content="Titolo:" FontWeight="Bold" Margin="5"/>
                                        <TextBox Grid.Row="0" Grid.Column="1" 
                                                 Text="{Binding Titolo, UpdateSourceTrigger=PropertyChanged}" 
                                                 Margin="5" Padding="5"/>

                                        <Label Grid.Row="1" Grid.Column="0" Content="Indirizzo:" FontWeight="Bold" Margin="5"/>
                                        <TextBox Grid.Row="1" Grid.Column="1" 
                                                 Text="{Binding Indirizzo, UpdateSourceTrigger=PropertyChanged}" 
                                                 Margin="5" Padding="5"/>

                                        <Label Grid.Row="2" Grid.Column="0" Content="Città:" FontWeight="Bold" Margin="5"/>
                                        <TextBox Grid.Row="2" Grid.Column="1" 
                                                 Text="{Binding Citta, UpdateSourceTrigger=PropertyChanged}" 
                                                 Margin="5" Padding="5"/>

                                        <Label Grid.Row="3" Grid.Column="0" Content="Prezzo (€):" FontWeight="Bold" Margin="5"/>
                                        <TextBox Grid.Row="3" Grid.Column="1" 
                                                 Text="{Binding Prezzo, UpdateSourceTrigger=PropertyChanged, StringFormat=N0}" 
                                                 Margin="5" Padding="5"/>

                                        <Label Grid.Row="4" Grid.Column="0" Content="Tipo:" FontWeight="Bold" Margin="5"/>
                                        <ComboBox Grid.Row="4" Grid.Column="1" 
                                                  ItemsSource="{Binding DataContext.TipiImmobile, RelativeSource={RelativeSource AncestorType=Grid, AncestorLevel=3}}" 
                                                  SelectedItem="{Binding TipoImmobile}" 
                                                  Margin="5" Padding="5"/>

                                        <Label Grid.Row="5" Grid.Column="0" Content="Superficie (mq):" FontWeight="Bold" Margin="5"/>
                                        <TextBox Grid.Row="5" Grid.Column="1" 
                                                 Text="{Binding Superficie, UpdateSourceTrigger=PropertyChanged}" 
                                                 Margin="5" Padding="5"/>

                                        <Label Grid.Row="6" Grid.Column="0" Content="Descrizione:" FontWeight="Bold" Margin="5"/>
                                        <TextBox Grid.Row="6" Grid.Column="1" 
                                                 Text="{Binding Descrizione, UpdateSourceTrigger=PropertyChanged}" 
                                                 Height="60" TextWrapping="Wrap" AcceptsReturn="True"
                                                 Margin="5" Padding="5"/>
                                    </Grid>
                                </GroupBox>

                                <GroupBox Header="📄 Documenti" Margin="5">
                                    <StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="5">
                                            <Button Content="📋 Planimetria" 
                                                    Command="{Binding DataContext.AddDocumentCommand, RelativeSource={RelativeSource AncestorType=Grid, AncestorLevel=4}}" 
                                                    CommandParameter="Planimetria" 
                                                    Background="#FF9C27B0" Foreground="White" Margin="2" Padding="8,4"/>
                                            <Button Content="📜 Visura" 
                                                    Command="{Binding DataContext.AddDocumentCommand, RelativeSource={RelativeSource AncestorType=Grid, AncestorLevel=4}}" 
                                                    CommandParameter="Visura" 
                                                    Background="#FF673AB7" Foreground="White" Margin="2" Padding="8,4"/>
                                            <Button Content="⚡ APE" 
                                                    Command="{Binding DataContext.AddDocumentCommand, RelativeSource={RelativeSource AncestorType=Grid, AncestorLevel=4}}" 
                                                    CommandParameter="APE" 
                                                    Background="#FF3F51B5" Foreground="White" Margin="2" Padding="8,4"/>
                                        </StackPanel>

                                        <ListBox ItemsSource="{Binding DataContext.DocumentiCorrente, RelativeSource={RelativeSource AncestorType=Grid, AncestorLevel=4}}" 
                                                 Height="100" Margin="5">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate>
                                                    <StackPanel Orientation="Horizontal">
                                                        <TextBlock Text="{Binding TipoDocumento}" FontWeight="Bold" Width="100"/>
                                                        <TextBlock Text="{Binding NomeFile}" Margin="10,0"/>
                                                        <Button Content="👁️" ToolTip="Apri"
                                                                Command="{Binding DataContext.OpenDocumentCommand, RelativeSource={RelativeSource AncestorType=ListBox}}" 
                                                                CommandParameter="{Binding}"
                                                                Background="#FF4CAF50" Foreground="White" Padding="5,2" Margin="5,0"/>
                                                    </StackPanel>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                    </StackPanel>
                                </GroupBox>

                                <GroupBox Header="📸 Foto" Margin="5">
                                    <StackPanel>
                                        <Button Content="📸 Aggiungi Foto" 
                                                Command="{Binding DataContext.AddPhotoCommand, RelativeSource={RelativeSource AncestorType=Grid, AncestorLevel=4}}" 
                                                HorizontalAlignment="Left" Margin="5" 
                                                Background="#FFFF5722" Foreground="White" Padding="10,5"/>

                                        <ListBox ItemsSource="{Binding DataContext.FotoCorrente, RelativeSource={RelativeSource AncestorType=Grid, AncestorLevel=4}}" 
                                                 Height="80" Margin="5">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate>
                                                    <StackPanel Orientation="Horizontal">
                                                        <TextBlock Text="📷" FontSize="16" Margin="5"/>
                                                        <TextBlock Text="{Binding NomeFile}" VerticalAlignment="Center"/>
                                                        <Button Content="🗑️" ToolTip="Elimina"
                                                                Command="{Binding DataContext.DeletePhotoCommand, RelativeSource={RelativeSource AncestorType=ListBox}}" 
                                                                CommandParameter="{Binding}"
                                                                Background="#FFF44336" Foreground="White" Padding="5,2" Margin="10,0"/>
                                                    </StackPanel>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                    </StackPanel>
                                </GroupBox>
                            </StackPanel>
                        </StackPanel>
                    </ScrollViewer>
                </Grid>
            </Grid>
        </DataTemplate>

        <DataTemplate DataType="{x:Type viewmodels:ClientiViewModel}">
            <TextBlock Text="Gestione Clienti - In Development" FontSize="24" HorizontalAlignment="Center" VerticalAlignment="Center"/>
        </DataTemplate>

        <DataTemplate DataType="{x:Type viewmodels:AppuntamentiViewModel}">
            <TextBlock Text="Gestione Appuntamenti - In Development" FontSize="24" HorizontalAlignment="Center" VerticalAlignment="Center"/>
        </DataTemplate>

        <!-- Stili -->
        <Style x:Key="SidebarButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="Normal"/>
            <Setter Property="Padding" Value="20,15"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="0">
                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                              VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                              Margin="{TemplateBinding Padding}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#FF3F51B5"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Background" Value="#FF303F9F"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsDashboardActive}" Value="True">
                    <Setter Property="Background" Value="#FF2196F3"/>
                    <Setter Property="FontWeight" Value="Bold"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding IsImmobiliActive}" Value="True">
                    <Setter Property="Background" Value="#FF2196F3"/>
                    <Setter Property="FontWeight" Value="Bold"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding IsClientiActive}" Value="True">
                    <Setter Property="Background" Value="#FF2196F3"/>
                    <Setter Property="FontWeight" Value="Bold"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding IsAppuntamentiActive}" Value="True">
                    <Setter Property="Background" Value="#FF2196F3"/>
                    <Setter Property="FontWeight" Value="Bold"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="QuickActionButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="#FF4CAF50"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="15,8"/>
            <Setter Property="Margin" Value="5"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#FF388E3C"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Menu Bar -->
        <Menu Grid.Row="0" Background="#FF37474F" Foreground="White" FontSize="12">
            <MenuItem Header="File" Foreground="White">
                <MenuItem Header="Backup Database" Foreground="Black" Command="{Binding BackupDatabaseCommand}"/>
                <MenuItem Header="Restore Database" Foreground="Black" Command="{Binding RestoreDatabaseCommand}"/>
                <Separator/>
                <MenuItem Header="Esci" Command="{Binding ExitApplicationCommand}"/>
            </MenuItem>
            <MenuItem Header="Azioni" Foreground="White">
                <MenuItem Header="Nuovo Immobile" Foreground="Black" Command="{Binding QuickAddImmobileCommand}"/>
                <MenuItem Header="Nuovo Cliente" Foreground="Black" Command="{Binding QuickAddClienteCommand}"/>
                <MenuItem Header="Nuovo Appuntamento" Foreground="Black" Command="{Binding QuickAddAppuntamentoCommand}"/>
                <Separator/>
                <MenuItem Header="Aggiorna Dati" Foreground="Black" Click="RefreshData_Click"/>
            </MenuItem>
            <MenuItem Header="Strumenti" Foreground="White">
                <MenuItem Header="Impostazioni" Foreground="Black" Command="{Binding SettingsCommand}"/>
            </MenuItem>
            <MenuItem Header="?" Foreground="White">
                <MenuItem Header="Informazioni" Foreground="Black" Command="{Binding AboutCommand}"/>
            </MenuItem>
        </Menu>

        <!-- Main Content Area -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Sidebar Navigation -->
            <Grid Grid.Column="0" Background="#FF455A64">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Logo/Title -->
                <StackPanel Grid.Row="0" Margin="20" HorizontalAlignment="Center">
                    <TextBlock Text="🏢" FontSize="48" HorizontalAlignment="Center" Margin="0,10"/>
                    <TextBlock Text="ImmobiGestio" FontSize="18" FontWeight="Bold" 
                               Foreground="White" HorizontalAlignment="Center"/>
                    <TextBlock Text="v2.0" FontSize="10" Foreground="#FFAAAA" 
                               HorizontalAlignment="Center" Margin="0,5,0,20"/>
                </StackPanel>

                <!-- Navigation Buttons -->
                <StackPanel Grid.Row="1" Margin="0,10">
                    <Button Content="📊 Dashboard" 
                            Command="{Binding NavigateToDashboardCommand}"
                            Style="{StaticResource SidebarButtonStyle}"/>

                    <Button Content="🏠 Immobili" 
                            Command="{Binding NavigateToImmobiliCommand}"
                            Style="{StaticResource SidebarButtonStyle}"/>

                    <Button Content="👥 Clienti" 
                            Command="{Binding NavigateToClientiCommand}"
                            Style="{StaticResource SidebarButtonStyle}"/>

                    <Button Content="📅 Appuntamenti" 
                            Command="{Binding NavigateToAppuntamentiCommand}"
                            Style="{StaticResource SidebarButtonStyle}"/>

                    <!-- Separator -->
                    <Rectangle Height="1" Fill="#FF607D8B" Margin="20,20"/>

                    <!-- Quick Actions -->
                    <TextBlock Text="Azioni Rapide" Foreground="#FFAAAAAA" FontSize="12" 
                               Margin="20,0,20,10" FontWeight="Bold"/>

                    <Button Content="➕ Nuovo Immobile" 
                            Command="{Binding QuickAddImmobileCommand}"
                            Style="{StaticResource QuickActionButtonStyle}"
                            Background="#FF2196F3" Margin="15,2"/>

                    <Button Content="👤 Nuovo Cliente" 
                            Command="{Binding QuickAddClienteCommand}"
                            Style="{StaticResource QuickActionButtonStyle}"
                            Background="#FF4CAF50" Margin="15,2"/>

                    <Button Content="📅 Nuovo Appuntamento" 
                            Command="{Binding QuickAddAppuntamentoCommand}"
                            Style="{StaticResource QuickActionButtonStyle}"
                            Background="#FFFF9800" Margin="15,2"/>
                </StackPanel>

                <!-- User Info / Status -->
                <StackPanel Grid.Row="2" Margin="20,10,20,20">
                    <Rectangle Height="1" Fill="#FF607D8B" Margin="0,0,0,10"/>
                    <TextBlock Text="👤 Amministratore" Foreground="White" FontSize="12"/>
                    <TextBlock Text="{Binding StatusMessage}" Foreground="#FFAAAAAA" FontSize="10" 
                               TextWrapping="Wrap" Margin="0,5,0,0"/>
                </StackPanel>
            </Grid>

            <!-- Splitter -->
            <GridSplitter Grid.Column="1" HorizontalAlignment="Stretch" Background="#FFBBBBBB"/>

            <!-- Content Area -->
            <Border Grid.Column="2" Background="White">
                <ContentPresenter Content="{Binding CurrentViewModel}"/>
            </Border>
        </Grid>

        <!-- Status Bar -->
        <StatusBar Grid.Row="2" Background="#FFF5F5F5" Height="25">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusMessage}" FontSize="11"/>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock Text="{Binding CurrentView, StringFormat=Vista corrente: {0}}" 
                           FontSize="11" Foreground="Gray"/>
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Right">
                <TextBlock Text="ImmobiGestio v2.0" FontSize="11" Foreground="Gray"/>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>